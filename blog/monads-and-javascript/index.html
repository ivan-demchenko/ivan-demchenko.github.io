<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Monads and JavaScript | Ivan's blog</title><meta name=keywords content="functional programming"><meta name=description content="There are countless articles that aim to describe what monads are. Sure, I can’t resist writing another one of my own.
Stepping into contexts In order to understand what monad is, however, we should start with a Functor. The classical analogy for a functor is a box. The value sits inside that box. The only way to interact with that value is to use map function. Here is the signature for map:"><meta name=author content><link rel=canonical href=https://ivan-demchenko.github.io/blog/monads-and-javascript/><link crossorigin=anonymous href=/assets/css/stylesheet.5cfc680b1eeaeef9efbced92d46c2a9e876b72ee14fba85846afc4cff9e6e6f8.css integrity="sha256-XPxoCx7q7vnvvO2S1Gwqnodrcu4U+6hYRq/Ez/nm5vg=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://ivan-demchenko.github.io/static/icon.png><link rel=icon type=image/png sizes=16x16 href=https://ivan-demchenko.github.io/static/icon16.png><link rel=icon type=image/png sizes=32x32 href=https://ivan-demchenko.github.io/static/icon32.png><link rel=apple-touch-icon href=https://ivan-demchenko.github.io/static/icon.png><link rel=mask-icon href=https://ivan-demchenko.github.io/static/icon.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-VHCCQB5KTN"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-VHCCQB5KTN")</script><meta property="og:title" content="Monads and JavaScript"><meta property="og:description" content="There are countless articles that aim to describe what monads are. Sure, I can’t resist writing another one of my own.
Stepping into contexts In order to understand what monad is, however, we should start with a Functor. The classical analogy for a functor is a box. The value sits inside that box. The only way to interact with that value is to use map function. Here is the signature for map:"><meta property="og:type" content="article"><meta property="og:url" content="https://ivan-demchenko.github.io/blog/monads-and-javascript/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2018-05-07T00:00:00+00:00"><meta property="article:modified_time" content="2018-05-07T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Monads and JavaScript"><meta name=twitter:description content="There are countless articles that aim to describe what monads are. Sure, I can’t resist writing another one of my own.
Stepping into contexts In order to understand what monad is, however, we should start with a Functor. The classical analogy for a functor is a box. The value sits inside that box. The only way to interact with that value is to use map function. Here is the signature for map:"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Blogs","item":"https://ivan-demchenko.github.io/blog/"},{"@type":"ListItem","position":2,"name":"Monads and JavaScript","item":"https://ivan-demchenko.github.io/blog/monads-and-javascript/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Monads and JavaScript","name":"Monads and JavaScript","description":"There are countless articles that aim to describe what monads are. Sure, I can’t resist writing another one of my own.\nStepping into contexts In order to understand what monad is, however, we should start with a Functor. The classical analogy for a functor is a box. The value sits inside that box. The only way to interact with that value is to use map function. Here is the signature for map:","keywords":["functional programming"],"articleBody":"There are countless articles that aim to describe what monads are. Sure, I can’t resist writing another one of my own.\nStepping into contexts In order to understand what monad is, however, we should start with a Functor. The classical analogy for a functor is a box. The value sits inside that box. The only way to interact with that value is to use map function. Here is the signature for map:\nmap :: f a -\u003e (a -\u003e b) -\u003e f b\nThis means that we can apply a function a -\u003e b to a functor that holds a value of type a and get a functor with the a value of type b inside. The functor itself (or the box) remains the same. For example, an array is a valid Functor:\nArray.prototype.map = (fn: (a: A): B): Array.\nnote: this is some sort of pseudocode\nThe box (or wrapper) analogy is good but not quite. The main purpose of a functor is to give a notion of a context. Here are few examples:\nMaybe a = Just a | Nothing for the computation that might fail. Either a b = Left a | Right b for the computation might have two outcomes. Traditionally, Left value is for an unfortunate or erroneous result. Right is for a successful outcome. Notice that this type takes two other types - a and b. As such, when you map over Either, you only exchange b. Therefore, if the computation failed, the error is propagated further, not b. Task e r it models an asynchronous action but doesn’t run it. Future e r similar Task but is strict. Reader e r this is a cool one. It represents a computation that depends on the environment e and the result would be r. A Function, really. Context-returning functions and composition We are getting closer to Monads. Say you have two functions like this:\nf :: a -\u003e m b g :: b -\u003e m c What does this m stand for? This is a context. Consider a function like this: const f = (userId: number): Promise =\u003e { ... }. Promise here is our m. Functions like these called Kleisli arrows. If we skipped m ? part of the signature, we could compose them easily into a function a -\u003e c. But now we can’t. Say, you wanted to fetch all friends of a user knowing only a userId. You could make an API call to fetch an Account and then make another call to fetch a list of Friends. As such, we could have two functions:\nconst fetchAccount = (userId: number): Promise const fetchFriends = (account: Account): Promise","wordCount":"1490","inLanguage":"en","datePublished":"2018-05-07T00:00:00Z","dateModified":"2018-05-07T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://ivan-demchenko.github.io/blog/monads-and-javascript/"},"publisher":{"@type":"Organization","name":"Ivan's blog","logo":{"@type":"ImageObject","url":"https://ivan-demchenko.github.io/static/icon.png"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://ivan-demchenko.github.io/ accesskey=h title="Ivan's blog (Alt + H)">Ivan's blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://ivan-demchenko.github.io/blog/ title=Blog><span>Blog</span></a></li><li><a href=https://ivan-demchenko.github.io/about/ title=About><span>About</span></a></li><li><a href=https://ivan-demchenko.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://ivan-demchenko.github.io/bookmarks/ title=Bookmarks><span>Bookmarks</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Monads and JavaScript</h1><div class=post-meta><span title='2018-05-07 00:00:00 +0000 UTC'>May 7, 2018</span>&nbsp;·&nbsp;7 min&nbsp;|&nbsp;<a href=https://github.com/ivan-demchenko/ivan-demchenko.github.io/blog/2018-05-07-monads-and-javascript.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=post-content><p>There are countless articles that aim to describe what monads are. Sure, I can’t resist writing another one of my own.</p><h2 id=stepping-into-contexts>Stepping into contexts<a hidden class=anchor aria-hidden=true href=#stepping-into-contexts>#</a></h2><p>In order to understand what monad is, however, we should start with a <code>Functor</code>. The classical analogy for a functor is a <em>box</em>. The value sits inside that <em>box</em>. The only way to interact with that value is to use <code>map</code> function. Here is the signature for <code>map</code>:</p><p><code>map :: f a -> (a -> b) -> f b</code></p><p>This means that we can apply a function <code>a -> b</code> to a functor that holds a value of type <code>a</code> and get a functor with the a value of type <code>b</code> inside. The functor itself (or the <em>box</em>) remains the same. For example, an array is a valid <code>Functor</code>:</p><p><code>Array&lt;A>.prototype.map = &lt;B>(fn: (a: A): B): Array&lt;B></code>.</p><p><em>note: this is some sort of pseudocode</em></p><p>The <em>box</em> (or <em>wrapper</em>) analogy is good but not quite. The main purpose of a functor is to give a notion of a <strong>context</strong>. Here are few examples:</p><ul><li><code>Maybe a = Just a | Nothing</code> for the computation that might fail.</li><li><code>Either a b = Left a | Right b</code> for the computation might have two outcomes.</li><li>Traditionally, <code>Left</code> value is for an unfortunate or erroneous result. <code>Right</code> is for a successful outcome. Notice that this type takes two other types - <code>a</code> and <code>b</code>. As such, when you <code>map</code> over <code>Either</code>, you only exchange <code>b</code>. Therefore, if the computation failed, the error is propagated further, not <code>b</code>.</li><li><code>Task e r</code> it models an asynchronous action but doesn’t run it.</li><li><code>Future e r</code> similar <code>Task</code> but is strict.</li><li><code>Reader e r</code> this is a cool one. It represents a computation that depends on the environment <code>e</code> and the result would be <code>r</code>. A Function, really.</li></ul><h2 id=context-returning-functions-and-composition>Context-returning functions and composition<a hidden class=anchor aria-hidden=true href=#context-returning-functions-and-composition>#</a></h2><p>We are getting closer to Monads. Say you have two functions like this:</p><ul><li><code>f :: a -> m b</code></li><li><code>g :: b -> m c</code></li></ul><p>What does this <code>m</code> stand for? This is a context. Consider a function like this: <code>const f = (userId: number): Promise&lt;Account> => { ... }</code>. <code>Promise</code> here is our <code>m</code>. Functions like these called Kleisli arrows. If we skipped <code>m ?</code> part of the signature, we could compose them easily into a function <code>a -> c</code>. But now we can’t. Say, you wanted to fetch all friends of a user knowing only a <code>userId</code>. You could make an API call to fetch an Account and then make another call to fetch a list of Friends. As such, we could have two functions:</p><ul><li><code>const fetchAccount = (userId: number): Promise&lt;Account></code></li><li><code>const fetchFriends = (account: Account): Promise&lt;Array&lt;Friend>></code></li></ul><p>In theory, I can’t compose these function as they are not just simple functions. However, Promises implement a swiss-knife-method which is <code>Promise.prototype.then</code>. In this particular case, <code>.then</code> can “extract” <code>Account</code> from the first promise and “pass it” to <code>fetchFriends</code>. In Haskell, this operator is denoted as <code>>>=</code> (also known as <code>bind</code>, <code>chain</code>, <code>flatMap</code>, <code>andThen</code>, and, of course, the only one, the super-star… <code>smooshMap</code>). <code>.then</code> can also be used as <code>.map</code>. Also, it can handle errors…</p><p>So, why did I mentioned Kleisli arrows? Because <code>>>=</code> helps to compose such functions. “Normal” or “simple” functions are composed using <code>(.)</code> operator (<a href=http://ramdajs.com/docs/#compose>compose</a> function in Ramda). Kleisli arrows are composed using <code>>>=</code> operator (<a href=http://ramdajs.com/docs/#composeK>composeK</a>). Simple.</p><h2 id=when-context-switching-is-good>When context switching is good<a hidden class=anchor aria-hidden=true href=#when-context-switching-is-good>#</a></h2><p>Okay, so now we can easily compose functions that use the same context. However, sometimes it is now enough. We need a way to jump from one context into another. Why? Consider a <code>head</code> function (or <code>array[0]</code>). It might return an <code>undefined</code>. And then we get <code>Cannot read .whatever from undefined</code> or something in our logs and our users keep clicking that button having no clue that the console could tell them that we forgot to check for the case of an empty array. However, we could spare another <code>if/else</code> if we did choose a type-safe way. We could build a nicer <code>head</code> function that could take us from a List/Array (one context) to a Maybe (another context). Like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>safeHead</span> <span style=color:#f92672>=</span> <span style=color:#f92672>&lt;</span><span style=color:#a6e22e>X</span><span style=color:#f92672>&gt;</span>(<span style=color:#a6e22e>arr</span><span style=color:#f92672>:</span> Array<span style=color:#f92672>&lt;</span><span style=color:#a6e22e>X</span><span style=color:#f92672>&gt;</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Maybe</span><span style=color:#f92672>&lt;</span><span style=color:#a6e22e>X</span><span style=color:#f92672>&gt;</span> { ... }
</span></span></code></pre></div><p>We could refactor this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>friend</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>myFriends</span>[<span style=color:#ae81ff>0</span>];
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>friend</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>goForSomeBeers</span>(<span style=color:#a6e22e>friend</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>… into this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>return</span> <span style=color:#a6e22e>saveHead</span>(<span style=color:#a6e22e>myFriends</span>).<span style=color:#a6e22e>map</span>(<span style=color:#a6e22e>goForSomeBeers</span>);
</span></span></code></pre></div><p>Good, we&rsquo;re getting closer to…</p><h3 id=natural-transformation>Natural Transformation<a hidden class=anchor aria-hidden=true href=#natural-transformation>#</a></h3><p>Okay, you’ve seen that we can move from one context into another. Let’s say, there’s a function that returns a value of <code>Either e a</code> and another function that takes a value of <code>Maybe a</code> type. Fairly common situation. In this case, we can just naturally transform one into another.</p><ul><li><code>List a -> Maybe a</code></li><li><code>Maybe a -> List a</code></li><li><code>Either e a -> Maybe a</code></li><li><code>Either e a -> Task e a</code></li></ul><p>There’s a catch though, not always we can easily jump between contexts. Sometimes, it is even impossible. For example,</p><ul><li><code>Task e a -> Either e a</code> as we have no idea when the async operation will produce a result. Therefore, we have to remain in the context of async operations.</li><li><code>Maybe a -> Either () a</code> in this case, we should choose some “default” value for the first type argument for <code>Either</code>.</li></ul><p>Some libraries implement methods that allow folding the data structure. For example, <a href=http://folktale.origamitower.com/>Folktale</a> implements <code>.matchWith</code> for data structures to fold into a value. But we can use this method to implement Natural Transformations. Here’s the example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>Result</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;folktale/result&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>Task</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;folktale/concurrency/task&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -- validateEmail :: String -&gt; Result String String
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>validateEmail</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>email</span>) =&gt;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>email</span>.<span style=color:#a6e22e>indexOf</span>(<span style=color:#e6db74>&#34;@&#34;</span>) <span style=color:#f92672>&gt;</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> <span style=color:#f92672>?</span> <span style=color:#a6e22e>Result</span>.<span style=color:#a6e22e>Ok</span>(<span style=color:#a6e22e>email</span>) <span style=color:#f92672>:</span> <span style=color:#a6e22e>Result</span>.Error(<span style=color:#e6db74>&#34;Bad email&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -- resultToTask :: Result String String -&gt; Task String String
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>resultToTask</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>result</span>) =&gt;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>matchWith</span>({
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Ok</span><span style=color:#f92672>:</span> ({ <span style=color:#a6e22e>value</span> }) =&gt; <span style=color:#a6e22e>Task</span>.<span style=color:#66d9ef>of</span>(<span style=color:#a6e22e>value</span>),
</span></span><span style=display:flex><span>    Error<span style=color:#f92672>:</span> ({ <span style=color:#a6e22e>value</span> }) =&gt; <span style=color:#a6e22e>Task</span>.<span style=color:#a6e22e>rejected</span>(<span style=color:#a6e22e>value</span>),
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>resultToTask</span>(<span style=color:#a6e22e>validateEmail</span>(<span style=color:#e6db74>&#34;abc@example.com&#34;</span>))
</span></span><span style=display:flex><span>  .<span style=color:#a6e22e>run</span>()
</span></span><span style=display:flex><span>  .<span style=color:#a6e22e>promise</span>()
</span></span><span style=display:flex><span>  .<span style=color:#a6e22e>then</span>(<span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>);
</span></span></code></pre></div><p>Here, <code>resultToTask</code> takes us from <code>Result a b</code> to <code>Task a b</code> and then <code>.promise()</code> converts a task into a promise.</p><p>Okay, having all this under our belts, we can finally move on to monad transformers.</p><p>Let’s meet another monad, <code>Reader</code>. This is a type that represents a computation that depends on the environment. Here’s the example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>Reader</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;fantasy-readers&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>DB</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>getUser</span><span style=color:#f92672>:</span> (<span style=color:#a6e22e>id</span>) =&gt; ({ <span style=color:#a6e22e>id</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`User</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> }),
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fetchUser</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>userId</span>) =&gt;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>Reader</span>((<span style=color:#a6e22e>env</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>getUser</span>(<span style=color:#a6e22e>userId</span>);
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>fetchUser</span>(<span style=color:#ae81ff>1</span>).<span style=color:#a6e22e>run</span>({ <span style=color:#a6e22e>db</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>DB</span> });
</span></span><span style=display:flex><span><span style=color:#75715e>// &gt; { id: 1, name: &#39;User 1&#39; }
</span></span></span></code></pre></div><p>There is a function that returns a <code>Reader e a</code> type. Let’s say having a user we have to fetch or generate an avatar.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>Reader</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;fantasy-readers&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>DB</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>getUser</span><span style=color:#f92672>:</span> (<span style=color:#a6e22e>id</span>) =&gt; ({ <span style=color:#a6e22e>id</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`User</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> }),
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>Network</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>fetchAvatar</span><span style=color:#f92672>:</span> (<span style=color:#a6e22e>userName</span>) =&gt; <span style=color:#e6db74>`/img/</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>userName</span>.<span style=color:#a6e22e>toLowerCase</span>()<span style=color:#e6db74>}</span><span style=color:#e6db74>.jpeg`</span>,
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -- fetchUser :: Int -&gt; Reader Env User
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fetchUser</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>userId</span>) =&gt;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>Reader</span>((<span style=color:#a6e22e>env</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>getUser</span>(<span style=color:#a6e22e>userId</span>);
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -- fetchAvatar :: User -&gt; Reader Env String
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fetchAvatar</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>user</span>) =&gt;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>Reader</span>((<span style=color:#a6e22e>env</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>network</span>.<span style=color:#a6e22e>fetchAvatar</span>(<span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>name</span>);
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>fetchUser</span>(<span style=color:#ae81ff>1</span>).<span style=color:#a6e22e>chain</span>(<span style=color:#a6e22e>fetchAvatar</span>).<span style=color:#a6e22e>run</span>({
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>db</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>DB</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>network</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>Network</span>,
</span></span><span style=display:flex><span>  })
</span></span><span style=display:flex><span>);
</span></span></code></pre></div><p>Look how nicely we can pass our dependencies using <code>Reader</code>! Now, remember Kleisli arrows? There are two functions here:</p><ul><li><code>fetchUser :: Int -> Reader Env User</code></li><li><code>fetchAvatar :: User -> Reader Env String</code></li></ul><p>If we strip reader noise away we get:</p><ul><li><code>fetchUser :: Int -> User</code></li><li><code>fetchAvatar :: User -> String</code></li></ul><p>As you can see without <code>Reader</code> we could have composed those functions easily using <code>compose</code>. However, we are in the context. Therefore, we use monadic interface - <code>.chain</code>. This is that simple. Now both function can read from the same <code>Env</code> but perform different operations and pass data according to the direction of the composition.</p><p>However, a computation might fail. Well, we have a context (or should I say Functor) for this! However, now we’re going to have a context within a context. Something like <code>Reader Env (Result e a)</code>. This means that if we want to reach to <code>a</code> we would need to <code>map</code> twice, <code>chain</code> twice and so on. And if we have yet another layer, then we would get triple maps/chains/etc. Not good. Instead, we could use <strong>Monad Transformers</strong> and, sort of, combine monads together. Here we’re going to use <code>Reader.ReaderT</code> and mix it with <code>Result</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>Reader</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;fantasy-readers&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>Result</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;folktale/result&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>ReaderResult</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Reader</span>.<span style=color:#a6e22e>ReaderT</span>(<span style=color:#a6e22e>Result</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>DB</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>getUser</span><span style=color:#f92672>:</span> (<span style=color:#a6e22e>id</span>) =&gt;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>typeof</span> <span style=color:#a6e22e>id</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#34;number&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>?</span> <span style=color:#a6e22e>Result</span>.<span style=color:#a6e22e>Ok</span>({ <span style=color:#a6e22e>id</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`User</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> })
</span></span><span style=display:flex><span>      <span style=color:#f92672>:</span> <span style=color:#a6e22e>Result</span>.Error(<span style=color:#e6db74>&#34;Bad userId&#34;</span>),
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>Network</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>fetchAvatar</span><span style=color:#f92672>:</span> (<span style=color:#a6e22e>userName</span>) =&gt; <span style=color:#a6e22e>Result</span>.<span style=color:#66d9ef>of</span>(<span style=color:#e6db74>`/img/</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>userName</span>.<span style=color:#a6e22e>toLowerCase</span>()<span style=color:#e6db74>}</span><span style=color:#e6db74>.jpeg`</span>),
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fetchUser</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>userId</span>) =&gt;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>ReaderResult</span>((<span style=color:#a6e22e>env</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>getUser</span>(<span style=color:#a6e22e>userId</span>);
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fetchAvatar</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>resUser</span>) =&gt;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>ReaderResult</span>((<span style=color:#a6e22e>env</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>network</span>.<span style=color:#a6e22e>fetchAvatar</span>(<span style=color:#a6e22e>resUser</span>.<span style=color:#a6e22e>name</span>);
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>fetchUser</span>(<span style=color:#ae81ff>1</span>).<span style=color:#a6e22e>chain</span>(<span style=color:#a6e22e>fetchAvatar</span>).<span style=color:#a6e22e>run</span>({
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>DB</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>network</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>Network</span>,
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span><span style=color:#75715e>// &gt; folktale:Result.Ok({ value: &#34;/img/user1.jpeg&#34; })
</span></span></span></code></pre></div><p>Can you spot what has changed? Right, instead of <code>Reader</code> we use our <code>ReaderResult</code>, also <code>DB.getUser</code> and <code>Network.fetchAvatar</code> returns a value of the type <code>Result</code>.</p><p>I think we could stop here, there’s a lot to go through. Anyway, I hope you got a better understanding of what monads are and what are they for.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://ivan-demchenko.github.io/tags/functional-programming/>functional programming</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://ivan-demchenko.github.io/>Ivan's blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script type=text/javascript>var sc_project=12781072,sc_invisible=1,sc_security="4d31877b"</script><script type=text/javascript src=https://www.statcounter.com/counter/counter.js async></script><noscript><div class=statcounter><a title="Web Analytics" href=https://statcounter.com/ target=_blank><img class=statcounter src=https://c.statcounter.com/12781072/0/4d31877b/1/ alt="Web Analytics" referrerpolicy=no-referrer-when-downgrade></a></div></noscript><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>